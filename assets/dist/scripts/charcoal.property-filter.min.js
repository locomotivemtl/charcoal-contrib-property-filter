/*! @locomotivemtl/charcoal-contrib-property-filter 28-10-2019 */

!function(t){var e=function(t){t.data.properties_options||(t.data.properties_options={}),Charcoal.Admin.Widget.call(this,t)};(e.prototype=Object.create(Charcoal.Admin.Widget.prototype)).constructor=Charcoal.Admin.Widget_Property_Filter,e.prototype.parent=Charcoal.Admin.Widget.prototype,e.prototype.init=function(){this.$form=this.element(),this.$form.on("submit.charcoal.property.filter",function(t){t.preventDefault(),t.stopPropagation(),this.submit()}.bind(this)),this.$form.on("click.charcoal.property.filter",".js-filter-reset",this.clear.bind(this))},e.prototype.clear=function(){return this.$form[0].reset(),this.$form.find("select").selectpicker("refresh"),this.submit(),this},e.prototype.submit=function(){var e,r,i,o,n={};return r=Charcoal.Admin.manager(),(i=r.components.widgets).length>0&&(this.$form.serializeArray(),e=this.$form.find(":input").serializeArray(),t.each(e,function(t,e){var r=e.name.replace(/(\[.*)/gi,"");e.value&&(n.hasOwnProperty(r)||(n[r]=[]),n[r].push(e.value))}),o=this.prepare_request(n),t.each(i,function(t,e){this.dispatch(o,e)}.bind(this))),this},e.prototype.prepare_request=function(e){var r,i,o=null,n=[],a=this.opts("data");return t.each(e,function(e,o){r=[],t.each(o,function(t,i){r.push({property:e,value:i})}),i=a.properties_options[e]||{},n.push({conjunction:i.conjunction||"AND",filters:r})}),n.length&&(o={filters:n}),o},e.prototype.dispatch=function(t,e){if(!e)return this;if("function"!=typeof e.set_filters)return this;void 0!==e.pagination&&(e.pagination.page=1);var r=[];return t&&r.push(t),e.set_filters(r),e.reload(),this},Charcoal.Admin.Widget_Property_Filter=e}(jQuery);